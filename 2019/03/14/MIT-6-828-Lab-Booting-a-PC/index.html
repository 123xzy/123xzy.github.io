<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="操作系统," />










<meta name="description" content="实验1：启动PC">
<meta name="keywords" content="操作系统">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT 6.828 Lab:Booting a PC">
<meta property="og:url" content="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/index.html">
<meta property="og:site_name" content="阿谢的BLOG">
<meta property="og:description" content="实验1：启动PC">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/1.JPG">
<meta property="og:image" content="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/2.JPG">
<meta property="og:image" content="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/3.JPG">
<meta property="og:image" content="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/4.JPG">
<meta property="og:image" content="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/5.JPG">
<meta property="og:image" content="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/6.JPG">
<meta property="og:updated_time" content="2019-03-17T02:59:19.660Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MIT 6.828 Lab:Booting a PC">
<meta name="twitter:description" content="实验1：启动PC">
<meta name="twitter:image" content="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/1.JPG">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/"/>





  <title>MIT 6.828 Lab:Booting a PC | 阿谢的BLOG</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">阿谢的BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-life">
          <a href="/Life" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Life
          </a>
        </li>
      
        
        <li class="menu-item menu-item-theory">
          <a href="/Theory" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Theory
          </a>
        </li>
      
        
        <li class="menu-item menu-item-practice">
          <a href="/Practice" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Practice
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/About" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/14/MIT-6-828-Lab-Booting-a-PC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="123xzy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿谢的BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MIT 6.828 Lab:Booting a PC</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-14T21:27:48+08:00">
                2019-03-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>实验1：启动PC<br><a id="more"></a></p>
<hr>
<p>该实验<a href="https://pdos.csail.mit.edu/6.828/2014/labs/lab1/" target="_blank" rel="noopener">原始指南</a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本实验分为三个部分</p>
<ul>
<li>getting familiarized with x86 assembly language, the QEMU x86 emulator, and the PC’s power-on bootstrap procedure</li>
<li>examines the boot loader for our 6.828 kernel</li>
<li>delves into the initial template for our 6.828 kernel itself</li>
</ul>
<h1 id="PC-Bootstrap"><a href="#PC-Bootstrap" class="headerlink" title="PC Bootstrap"></a>PC Bootstrap</h1><p>介绍x86汇编语言和PC引导程序，并开始使用QEMU和QEMU/GDB调试</p>
<h2 id="Getting-Started-with-x86-assembly"><a href="#Getting-Started-with-x86-assembly" class="headerlink" title="Getting Started with x86 assembly"></a>Getting Started with x86 assembly</h2><p>MIT官方为我们提供了一个关于汇编语言的参考资料<a href="https://pdos.csail.mit.edu/6.828/2014/readings/pcasm-book.pdf" target="_blank" rel="noopener">pcasm-book</a>，里面基本介绍了汇编语言的方方面面，你可以把这本书作为一个备查，遇到没看过的命令就上里面查，或者直接上网查。如果没有任何汇编基础，建议还是看一看书，把一些基础的指令看懂</p>
<p>本书中的示例是为NASM汇编程序编写的，而我们将使用GNU汇编程序。NASM使用所谓的Intel语法，而GNU使用AT＆T语法。虽然在语义上是等效的，但是程序集文件会有很大不同，至少表面上看，这取决于使用的语法。幸运的是，两者之间的转换非常简单，并且在<a href="http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html" target="_blank" rel="noopener">汇编指南</a>中有所介绍</p>
<h2 id="Simulating-the-x86"><a href="#Simulating-the-x86" class="headerlink" title="Simulating the x86"></a>Simulating the x86</h2><p><code>Instead of developing the operating system on a real, physical personal computer (PC), we use a program that faithfully emulates a complete PC: the code you write for the emulator will boot on a real PC too. Using an emulator simplifies debugging; you can, for example, set break points inside of the emulated x86, which is difficult to do with the silicon version of an x86.</code></p>
<p>进行该部分需要安装QEMU（<a href="/2019/03/08/MIT-6-828-Lab-Guide/" title="MIT 6.828 Lab:Guide">MIT 6.828 Lab:Guide</a>，该文章中有实验的所有前期准备指南）和熟悉GDB调试（<a href="/2018/03/11/GDB-GCC/" title="GDB GCC">GDB GCC</a>）</p>
<p><code>Everything after &#39;Booting from Hard Disk...&#39; was printed by our skeletal JOS kernel; the K&gt; is the prompt printed by the small monitor, or interactive control program, that we&#39;ve included in the kernel. These lines printed by the kernel will also appear in the regular shell window from which you ran QEMU. This is because for testing and lab grading purposes we have set up the JOS kernel to write its console output not only to the virtual VGA display (as seen in the QEMU window), but also to the simulated PC&#39;s virtual serial port, which QEMU in turn outputs to its own standard output.</code></p>
<p>启动给内核之后，所有字符就是由<code>JOS kernel</code>产生</p>
<p><code>There are only two commands you can give to the kernel monitor, help and kerninfo.</code></p>
<p>现在只有两个命令可以使用：<code>help</code> <code>kerninfo</code><br><img src="/2019/03/14/MIT-6-828-Lab-Booting-a-PC/1.JPG" alt="运行截图"></p>
<p><code>Although simple, it&#39;s important to note that this kernel monitor is running &quot;directly&quot; on the &quot;raw (virtual) hardware&quot; of the simulated PC. This means that you should be able to copy the contents of obj/kern/kernel.img onto the first few sectors of a real hard disk, insert that hard disk into a real PC, turn it on, and see exactly the same thing on the PC&#39;s real screen as you did above in the QEMU window</code></p>
<p>虽然该内核还比较简单，但只要愿意，可以将该内核镜像写入硬盘前几个扇区，就能想真正启动PC一样启动它，并能看到完全一样的东西</p>
<h2 id="The-PC’s-Physical-Address-Space"><a href="#The-PC’s-Physical-Address-Space" class="headerlink" title="The PC’s Physical Address Space"></a>The PC’s Physical Address Space</h2><p><code>A PC&#39;s physical address space is hard-wired to have the following general layout:</code><br><img src="/2019/03/14/MIT-6-828-Lab-Booting-a-PC/2.JPG" alt="运行截图"></p>
<p>早期基于16位Intel 8088处理器只能操作1MB物理内存，因此物理地址空间起始于0x00000000到0x000FFFFF，其中640KB为<code>Low memory</code>，这只能被随机存储器(RAM)使用</p>
<p>从<code>0x000A0000</code>到<code>0x000FFFFF</code>的384KB留着给特殊使用，例如作为视频显示缓存或者储存在非易失存储器的硬件。从<code>0x000F0000</code>到<code>0x000FFFFF</code>占据64KB区域的部分是最重要的<strong>BIOS</strong></p>
<p>现在的x86处理器支持超过4GB的物理RAM，所以RAM扩展到了<code>0xFFFFFFFF</code>。<code>JOS</code>这里只用开始的256MB，所以假设PC只有32位地址空间</p>
<h2 id="The-ROM-BIOS"><a href="#The-ROM-BIOS" class="headerlink" title="The ROM BIOS"></a>The ROM BIOS</h2><p>这部分研究计算机如何<strong>启动</strong></p>
<p>在一个终端中输入<code>make qemu-gdb</code>，这将启动QEMU，但QEMU在处理器执行第一条指令之前停止，并等待来自GDB的调试连接，另一个终端输入<code>make gdb</code><img src="/2019/03/14/MIT-6-828-Lab-Booting-a-PC/3.JPG" alt="运行截图"></p>
<p><code>[f000:fff0]    0xffff0:    ljmp   $0xf000,$0xe05b</code>是GDB反汇编出的第一条执行指令，表明：</p>
<ul>
<li>IBM PC从物理地址<code>0x000ffff0</code>处执行，该地址位于为ROM BIOS保留的64KB区域的最顶端</li>
<li>PC从地址<code>CS=0xf000,IP=0xfff0</code>开始执行</li>
<li>执行的第一条指令是<code>jmp</code>指令，它跳转到分段地址<code>CS = 0xf000,IP=0xe05b</code></li>
</ul>
<p>由于PC中的BIOS与物理地址范围<code>0x000f0000-0x000fffff</code>“硬连线”，因此该设计可确保BIOS在上电或任何系统重启后始终首先控制机器。QEMU仿真器带有自己的BIOS，它放置在处理器的模拟物理地址空间中的位置。当通电后，处理器进入实模式也就是设置<code>CS:IP</code>两个寄存器为<code>CS=0xf000,IP=0xfff0</code>，为什么这个段地址指示的是<code>0x000ffff0</code>？</p>
<p>因为在启动电源也就是实模式时，地址转译根据这个公式工作：<code>物理地址=16 * 段地址+偏移量</code></p>
<p><code>0x000ffff0</code>是BIOS结束前的16个字节（<code>0x100000</code>）</p>
<p>当BIOS启动，它设置了一个中断描述符表并初始化多个设备比如VGA显示器。在初始化PCI总线和所有重要的设备之后，它寻找可引导的设备，之后读取<code>Boot loader</code>并转移控制</p>
<p><img src="/2019/03/14/MIT-6-828-Lab-Booting-a-PC/4.JPG" alt="运行截图">可以通过GDB<code>si</code>命令一步步猜测BIOS正在做什么！</p>
<h1 id="The-Boot-Loader"><a href="#The-Boot-Loader" class="headerlink" title="The Boot Loader"></a>The Boot Loader</h1><p>PC的软盘和硬盘分为512个字节区域，称为扇区。扇区是磁盘的最小传输粒度：每个读取或写入操作必须是一个或多个扇区，并在扇区边界上对齐。如果磁盘是可引导的，则第一个扇区称为引导扇区，因为这是引导加载程序代码所在的位置。当BIOS找到可引导的软盘或硬盘时，它将512字节的引导扇区加载到物理地址<code>0x7c00</code>到<code>0x7dff</code>的内存中，然后使用jmp指令将<code>CS：IP</code>设置为<code>0000：7c00</code>，将控制权传递给引导装载机</p>
<p>对于6.828，引导加载程序包含一个汇编语言源文件<code>boot/boot.S</code>和一个C源文件<code>boot/main.c</code>，仔细查看这些源文件，确保您了解正在发生的事情</p>
<p>在<code>main.c</code>有以下注释，详细讲述了启动流程<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment"> * This a dirt simple boot loader, whose sole job is to boot</span></span><br><span class="line"><span class="comment"> * an ELF kernel image from the first IDE hard disk.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * DISK LAYOUT</span></span><br><span class="line"><span class="comment"> *  * This program(boot.S and main.c) is the bootloader.  It should</span></span><br><span class="line"><span class="comment"> *    be stored in the first sector of the disk.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * The 2nd sector onward holds the kernel image.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * The kernel image must be in ELF format.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * BOOT UP STEPS</span></span><br><span class="line"><span class="comment"> *  * when the CPU boots it loads the BIOS into memory and executes it</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * the BIOS intializes devices, sets of the interrupt routines, and</span></span><br><span class="line"><span class="comment"> *    reads the first sector of the boot device(e.g., hard-drive)</span></span><br><span class="line"><span class="comment"> *    into memory and jumps to it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * Assuming this boot loader is stored in the first sector of the</span></span><br><span class="line"><span class="comment"> *    hard-drive, this code takes over...</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * control starts in boot.S -- which sets up protected mode,</span></span><br><span class="line"><span class="comment"> *    and a stack so C code then run, then calls bootmain()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * bootmain() in this file takes over, reads in the kernel and jumps to it.</span></span><br><span class="line"><span class="comment"> **********************************************************************/</span></span><br></pre></td></tr></table></figure></p>
<p>引导加载程序执行两个主要功能：</p>
<ul>
<li>引导加载程序将处理器从实模式切换到32位保护模式，因为只有在此模式下，软件才能访问处理器物理地址空间中1MB以上的所有内存</li>
<li>引导加载程序通过x86的特殊I/O指令直接访问IDE磁盘设备寄存器，从硬盘读取内核</li>
</ul>
<p>在了解了引导加载程序源代码之后，查看文件<code>obj/boot/boot.asm</code>。此文件是我们的<code>GNUmakefile</code>在编译引导加载程序后创建的引导加载程序的反汇编。这个反汇编文件可以很容易地查看所有引导加载程序代码所在的物理内存的确切位置，并且可以更轻松地跟踪在GDB中单步执行引导加载程序时发生的情况。同样，<code>obj/kern/kernel.asm</code>包含一个JOS内核的反汇编，它通常可用于调试</p>
<h2 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h2><p>在地址0x7c00处设置断点，这是加载引导扇区的位置。继续执行直到该断点。通过跟踪开机代码<code>/boot.S</code>、使用的源代码、反汇编文件<code>OBJ的/boot/boot.asm</code>跟踪你在哪里。还可以使用GDB中的<code>x/i</code>命令来反汇编引导加载程序中的指令序列，并将原始引导加载程序代码与<code>obj/boot/boot.asm</code>和GDB中的反汇编进行比较</p>
<p><img src="/2019/03/14/MIT-6-828-Lab-Booting-a-PC/5.JPG" alt="运行截图"></p>
<p>跟踪<code>main.c/bootmain()</code>，然后进入<code>readsect()</code> 。确定与<code>readsect()</code>中每个语句对应的精确汇编指令。跟踪<code>readsect()</code>的其余部分并返回到<code>bootmain()</code>，并识别for循环的开始和结束，从磁盘读取内核的剩余扇区。找出循环结束时将运行的代码，在那里设置断点，并继续该断点。然后逐步执行引导加载程序的其余部分</p>
<p>问题：</p>
<ul>
<li>At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode?<br><img src="/2019/03/14/MIT-6-828-Lab-Booting-a-PC/6.JPG" alt="运行截图"></li>
<li><p>What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// call the entry point from the ELF header</span></span><br><span class="line"><span class="comment">// note: does not return!</span></span><br><span class="line">((<span class="keyword">void</span> (*)(<span class="keyword">void</span>)) (ELFHDR-&gt;e_entry))();</span><br><span class="line"></span><br><span class="line">(gdb) si</span><br><span class="line">=&gt; <span class="number">0x10000c</span>:	movw   $<span class="number">0x1234</span>,<span class="number">0x472</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information?<br>通过查看ELF信息头查看</p>
</li>
</ul>
<p>回答完这三个命令，我们再好好看一看这几段代码！<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">bootmain(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// read 1st page off disk</span></span><br><span class="line">        readseg((<span class="keyword">uint32_t</span>) ELFHDR, SECTSIZE*<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// is this a valid ELF?</span></span><br><span class="line">        <span class="keyword">if</span> (ELFHDR-&gt;e_magic != ELF_MAGIC)</span><br><span class="line">                <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load each program segment (ignores ph flags)</span></span><br><span class="line">        ph = (struct Proghdr *) ((<span class="keyword">uint8_t</span> *) ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">        eph = ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">        <span class="keyword">for</span> (; ph &lt; eph; ph++)</span><br><span class="line">                <span class="comment">// p_pa is the load address of this segment (as well</span></span><br><span class="line">                <span class="comment">// as the physical address)</span></span><br><span class="line">                readseg(ph-&gt;p_pa, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// call the entry point from the ELF header</span></span><br><span class="line">        <span class="comment">// note: does not return!</span></span><br><span class="line">        ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>)) (ELFHDR-&gt;e_entry))();</span><br><span class="line"></span><br><span class="line">bad:</span><br><span class="line">        outw(<span class="number">0x8A00</span>, <span class="number">0x8A00</span>);</span><br><span class="line">        outw(<span class="number">0x8A00</span>, <span class="number">0x8E00</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">                <span class="comment">/* do nothing */</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>bootmain</code>先读取ELF文件头信息（关于ELF文件，可以查看<a href="/2019/01/07/修养-《目标文件》/" title="《目标文件》">《目标文件》</a>），获取文件大小，然后判断魔数，然后调用<code>readseg</code>函数循环读取扇区内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read 'count' bytes at 'offset' from kernel into physical address 'pa'.</span></span><br><span class="line"><span class="comment">// Might copy more than asked</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">readseg(<span class="keyword">uint32_t</span> pa, <span class="keyword">uint32_t</span> count, <span class="keyword">uint32_t</span> offset)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> end_pa;</span><br><span class="line"></span><br><span class="line">        end_pa = pa + count;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// round down to sector boundary</span></span><br><span class="line">        pa &amp;= ~(SECTSIZE - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// translate from bytes to sectors, and kernel starts at sector 1</span></span><br><span class="line">        offset = (offset / SECTSIZE) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this is too slow, we could read lots of sectors at a time.</span></span><br><span class="line">        <span class="comment">// We'd write more to memory than asked, but it doesn't matter --</span></span><br><span class="line">        <span class="comment">// we load in increasing order.</span></span><br><span class="line">        <span class="keyword">while</span> (pa &lt; end_pa) &#123;</span><br><span class="line">                <span class="comment">// Since we haven't enabled paging yet and we're using</span></span><br><span class="line">                <span class="comment">// an identity segment mapping (see boot.S), we can</span></span><br><span class="line">                <span class="comment">// use physical addresses directly.  This won't be the</span></span><br><span class="line">                <span class="comment">// case once JOS enables the MMU.</span></span><br><span class="line">                readsect((<span class="keyword">uint8_t</span>*) pa, offset);</span><br><span class="line">                pa += SECTSIZE;</span><br><span class="line">                offset++;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数有3个参数，第一个是物理地址，第二个是页的大小，第三个是偏移量。函数先计算末尾地址，在根据字节数得出扇区号，最后循环读取扇区内容到内存地址<code>pa</code>处，读完之后，移动内存地址和扇区</p>
<p>数据读取之后，就返回<code>bootmian</code>，进入ELF记录的入口地址，进而由内核来操控。Exercise 3因而结束</p>
<h2 id="Loading-the-Kernel"><a href="#Loading-the-Kernel" class="headerlink" title="Loading the Kernel"></a>Loading the Kernel</h2><p>现在，我们将在<code>boot/main.c</code>中的引导加载程序的C语言部分详细介绍</p>
<h2 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h2><p>阅读Brian Kernighan和Dennis Ritchie编写的<a href="https://github.com/123xzy/K-R" target="_blank" rel="noopener">《C程序设计语言》</a>（称为“K＆R”）中的5.5和5.1，并理解<a href="https://pdos.csail.mit.edu/6.828/2014/labs/lab1/pointers.c" target="_blank" rel="noopener">pointers.c</a></p>
<h1 id="The-Kernel"><a href="#The-Kernel" class="headerlink" title="The Kernel"></a>The Kernel</h1><p>我们现在将开始更详细地研究JOS内核（最后你会写一些代码！）。与引导加载程序一样，内核以一些汇编语言代码开始，这些代码设置正确，以便C语言代码可以正确执行</p>
<h2 id="Using-virtual-memory-to-work-around-position-dependence"><a href="#Using-virtual-memory-to-work-around-position-dependence" class="headerlink" title="Using virtual memory to work around position dependence"></a>Using virtual memory to work around position dependence</h2><h2 id="Formatted-Printing-to-the-Console"><a href="#Formatted-Printing-to-the-Console" class="headerlink" title="Formatted Printing to the Console"></a>Formatted Printing to the Console</h2><h2 id="The-Stack"><a href="#The-Stack" class="headerlink" title="The Stack"></a>The Stack</h2>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/操作系统/" rel="tag"><i class="fa fa-tag"></i> 操作系统</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/14/Redis：多机数据库的实现/" rel="next" title="《多机数据库的实现》">
                <i class="fa fa-chevron-left"></i> 《多机数据库的实现》
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/15/lab-data/" rel="prev" title="Data">
                Data <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">123xzy</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">206</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">80</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/123xzy" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xzy-71-59/activities" target="_blank" title="ZhiHu">
                      
                        <i class="fa fa-fw fa-globe"></i>ZhiHu</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:xzy0320@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PC-Bootstrap"><span class="nav-number">2.</span> <span class="nav-text">PC Bootstrap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Getting-Started-with-x86-assembly"><span class="nav-number">2.1.</span> <span class="nav-text">Getting Started with x86 assembly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Simulating-the-x86"><span class="nav-number">2.2.</span> <span class="nav-text">Simulating the x86</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-PC’s-Physical-Address-Space"><span class="nav-number">2.3.</span> <span class="nav-text">The PC’s Physical Address Space</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-ROM-BIOS"><span class="nav-number">2.4.</span> <span class="nav-text">The ROM BIOS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-Boot-Loader"><span class="nav-number">3.</span> <span class="nav-text">The Boot Loader</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Exercise-3"><span class="nav-number">3.1.</span> <span class="nav-text">Exercise 3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Loading-the-Kernel"><span class="nav-number">3.2.</span> <span class="nav-text">Loading the Kernel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exercise-4"><span class="nav-number">3.3.</span> <span class="nav-text">Exercise 4</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-Kernel"><span class="nav-number">4.</span> <span class="nav-text">The Kernel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Using-virtual-memory-to-work-around-position-dependence"><span class="nav-number">4.1.</span> <span class="nav-text">Using virtual memory to work around position dependence</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Formatted-Printing-to-the-Console"><span class="nav-number">4.2.</span> <span class="nav-text">Formatted Printing to the Console</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Stack"><span class="nav-number">4.3.</span> <span class="nav-text">The Stack</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">123xzy</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  :<span id="busuanzi_value_site_uv"></span>
</span>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  


  

  

</body>
</html>
